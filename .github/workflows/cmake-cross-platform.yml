name: CMake (Linux + macOS)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  BUILD_DIR: build
  BUILD_TYPE: Release
  CCACHE_DIR: ${{ github.workspace }}/.ccache
  CCACHE_COMPRESS: true
  CCACHE_COMPRESSLEVEL: 6
  CCACHE_MAXSIZE: 400M

jobs:
  build-linux:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        lfs: true

    - name: Install build deps
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libavformat-dev libavcodec-dev libavfilter-dev \
          libavutil-dev libswscale-dev \
          libfreetype6-dev libharfbuzz-dev \
          ccache

    - name: Setup ccache
      uses: actions/cache@v4
      with:
        path: .ccache
        key: ${{ runner.os }}-ccache-${{ hashFiles('**/CMakeLists.txt', '**/*.cpp', '**/*.h') }}
        restore-keys: |
          ${{ runner.os }}-ccache-

    - name: Configure ccache
      run: |
        ccache --set-config=max_size=400M
        ccache --set-config=compression=true
        ccache --zero-stats

    - name: Configure CMake
      run: |
        cmake -B $BUILD_DIR \
          -DCMAKE_BUILD_TYPE=$BUILD_TYPE \
          -DCMAKE_C_COMPILER_LAUNCHER=ccache \
          -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
          -S ${{ github.workspace }}

    - name: Build
      run: cmake --build $BUILD_DIR --config $BUILD_TYPE

    - name: Show ccache statistics
      run: ccache --show-stats

    - name: Extract test data
      run: tar -xf data.tar

    - name: Test
      run: |
        cd "$BUILD_DIR"
        ctest --build-config "$BUILD_TYPE" --rerun-failed --output-on-failure

  build-macos:
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v4
      with:
        lfs: true

    - name: Install FFmpeg dependencies
      run: |
        brew update
        brew install ffmpeg freetype harfbuzz ccache

    - name: Setup ccache
      uses: actions/cache@v4
      with:
        path: .ccache
        key: ${{ runner.os }}-ccache-${{ hashFiles('**/CMakeLists.txt', '**/*.cpp', '**/*.h') }}
        restore-keys: |
          ${{ runner.os }}-ccache-

    - name: Configure ccache
      run: |
        ccache --set-config=max_size=400M
        ccache --set-config=compression=true
        ccache --zero-stats

    - name: Export FFmpeg pkgconfig paths (macOS)
      run: |
        export PKG_CONFIG_PATH="/opt/homebrew/opt/ffmpeg/lib/pkgconfig:/usr/local/opt/ffmpeg/lib/pkgconfig:$PKG_CONFIG_PATH"
        echo "PKG_CONFIG_PATH=$PKG_CONFIG_PATH" >> $GITHUB_ENV

    - name: Configure CMake
      run: |
        cmake -B $BUILD_DIR \
          -DCMAKE_BUILD_TYPE=$BUILD_TYPE \
          -DCMAKE_C_COMPILER_LAUNCHER=ccache \
          -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
          -S ${{ github.workspace }}

    - name: Build
      run: cmake --build $BUILD_DIR --config $BUILD_TYPE

    - name: Show ccache statistics
      run: ccache --show-stats

    - name: Extract test data
      run: tar -xf data.tar

    - name: Test
      run: |
        cd "$BUILD_DIR"
        ctest --build-config "$BUILD_TYPE" --rerun-failed --output-on-failure